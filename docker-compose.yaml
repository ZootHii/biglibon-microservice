services:
  eureka-server:
    image: 'biglibon-microservice-eureka-server:latest'
    container_name: eureka-server
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8761:8761"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      SERVER_PORT: 8761
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      EUREKA_INSTANCE_HOSTNAME: eureka-server
    networks:
      - biglibon-network
    healthcheck:
      test: [ "CMD-SHELL", "bash -ec '</dev/tcp/localhost/8761'" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    depends_on:
      postgres-db:
        condition: service_healthy
      mongo-db:
        condition: service_healthy
      kafka-4:
        condition: service_healthy
      kafka-5:
        condition: service_healthy
      kafka-6:
        condition: service_healthy
      kafka-7:
        condition: service_healthy
      elastic-1:
        condition: service_healthy
      elastic-2:
        condition: service_healthy
      elastic-3:
        condition: service_healthy

  api-gateway:
    image: 'biglibon-microservice-api-gateway:latest'
    container_name: api-gateway
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8888:8888"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      SERVER_PORT: 8888
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      SPRING_APPLICATION_NAME: api-gateway
    networks:
      - biglibon-network
    healthcheck:
      test: [ "CMD-SHELL", "bash -ec \"exec 3<>/dev/tcp/localhost/8888; printf 'GET /actuator/health HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3; cat <&3 | grep -q '\\\"status\\\":\\\"UP\\\"'\"" ]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 40s
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres-db:
        condition: service_healthy
      mongo-db:
        condition: service_healthy
      kafka-4:
        condition: service_healthy
      kafka-5:
        condition: service_healthy
      kafka-6:
        condition: service_healthy
      kafka-7:
        condition: service_healthy
      elastic-1:
        condition: service_healthy
      elastic-2:
        condition: service_healthy
      elastic-3:
        condition: service_healthy

  book-service:
    image: 'biglibon-microservice-book-service:latest'
    build:
      context: ./book-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_URL}
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: ${EUREKA_PREFER_IP}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_DATA_MONGODB_HOST: ${MONGO_DB_HOST}
      SPRING_DATA_MONGODB_PORT: ${MONGO_DB_PORT}
      SPRING_DATA_MONGODB_DATABASE: ${MONGO_DB}
      SPRING_DATA_MONGODB_USERNAME: ${MONGO_USER}
      SPRING_DATA_MONGODB_PASSWORD: ${MONGO_PASSWORD}
      MANAGEMENT_SERVER_PORT: 8081
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    networks:
      - biglibon-network
    healthcheck:
      test: ["CMD-SHELL", "bash -ec \"exec 3<>/dev/tcp/localhost/8081; printf 'GET /actuator/health HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3; cat <&3 | grep -q '\\\"status\\\":\\\"UP\\\"'\""]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    depends_on:
      api-gateway:
        condition: service_healthy
      postgres-db:
        condition: service_healthy
      mongo-db:
        condition: service_healthy
      kafka-4:
        condition: service_healthy
      kafka-5:
        condition: service_healthy
      kafka-6:
        condition: service_healthy
      kafka-7:
        condition: service_healthy
      elastic-1:
        condition: service_healthy
      elastic-2:
        condition: service_healthy
      elastic-3:
        condition: service_healthy

  library-service:
    image: 'biglibon-microservice-library-service:latest'
    build:
      context: ./library-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_URL}
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: ${EUREKA_PREFER_IP}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_DATASOURCE_HOST: ${POSTGRES_DB_HOST}
      SPRING_DATASOURCE_PORT: ${POSTGRES_DB_PORT}
      SPRING_DATASOURCE_DB: ${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      MANAGEMENT_SERVER_PORT: 8081
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    networks:
      - biglibon-network
    healthcheck:
      test: ["CMD-SHELL", "bash -ec \"exec 3<>/dev/tcp/localhost/8081; printf 'GET /actuator/health HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3; cat <&3 | grep -q '\\\"status\\\":\\\"UP\\\"'\""]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    depends_on:
      book-service:
        condition: service_healthy
      postgres-db:
        condition: service_healthy
      mongo-db:
        condition: service_healthy
      kafka-4:
        condition: service_healthy
      kafka-5:
        condition: service_healthy
      kafka-6:
        condition: service_healthy
      kafka-7:
        condition: service_healthy
      elastic-1:
        condition: service_healthy
      elastic-2:
        condition: service_healthy
      elastic-3:
        condition: service_healthy

  catalog-service:
    image: 'biglibon-microservice-catalog-service:latest'
    build:
      context: .
      dockerfile: catalog-service/Dockerfile
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_URL}
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: ${EUREKA_PREFER_IP}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      SPRING_DATA_MONGODB_HOST: ${MONGO_DB_HOST}
      SPRING_DATA_MONGODB_PORT: ${MONGO_DB_PORT}
      SPRING_DATA_MONGODB_DATABASE: ${MONGO_DB}
      SPRING_DATA_MONGODB_USERNAME: ${MONGO_USER}
      SPRING_DATA_MONGODB_PASSWORD: ${MONGO_PASSWORD}
      ELASTICSEARCH_URI: ${ELASTICSEARCH_URI}
      ELASTICSEARCH_USERNAME: ${ELASTICSEARCH_USERNAME}
      ELASTICSEARCH_PASSWORD: ${ELASTIC_PASSWORD}
      MANAGEMENT_SERVER_PORT: 8081
    volumes:
      - ${ELASTIC_CERTS_PATH}:/catalog-service/elasticsearch/certs:ro  # app iÃ§inde sertifika mount
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    networks:
      - biglibon-network
    healthcheck:
      test: ["CMD-SHELL", "bash -ec \"exec 3<>/dev/tcp/localhost/8081; printf 'GET /actuator/health HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3; cat <&3 | grep -q '\\\"status\\\":\\\"UP\\\"'\""]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    depends_on:
      library-service:
        condition: service_healthy
      postgres-db:
        condition: service_healthy
      mongo-db:
        condition: service_healthy
      kafka-4:
        condition: service_healthy
      kafka-5:
        condition: service_healthy
      kafka-6:
        condition: service_healthy
      kafka-7:
        condition: service_healthy
      elastic-1:
        condition: service_healthy
      elastic-2:
        condition: service_healthy
      elastic-3:
        condition: service_healthy

####### Networks #######
networks:
  biglibon-network: